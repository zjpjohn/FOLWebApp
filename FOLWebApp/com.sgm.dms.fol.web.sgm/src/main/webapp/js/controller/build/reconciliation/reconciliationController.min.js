/*! web.sgm 2016-09-28 */
FolController.controller("DealerReconciliationImportController",["$scope","$state","$timeout","$window","DealerReconciliationImportService",function(a,b,c,d,e){a.istableshow=!1,a.isdeatiltableshow=!1,c(function(){folUtil.setComboBoxYearDataById("year"),folUtil.setComboBoxMonthDataById("month");var b=$("#datagrid").datagrid("getPager");b.pagination({onSelectPage:function(b,c){a.query_data.beginNo=c*(b-1)==0?0:c*(b-1)+1,a.query_data.endNo=c*b,$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.query(a.query_data,"reconciliation/billFile/queryBillFile",function(a,b){$.messager.progress("close"),$("#datagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})}})}),a.query=function(){a.istableshow=!0;var b=folUtil.getComboBoxDataById("year")+"-"+folUtil.convertMonthToTwoPoint(folUtil.getComboBoxDataById("month"));a.$apply(function(){a.query_data={currentDate:b,year:folUtil.getComboBoxDataById("year"),month:folUtil.convertMonthToTwoPoint(folUtil.getComboBoxDataById("month")),beginNo:0,endNo:10}}),$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.query(a.query_data,"reconciliation/billFile/queryBillFile",function(a,b){$.messager.progress("close"),$("#datagrid").datagrid("loadData",{total:0,rows:[]}),$("#datagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})},a.checkIn=function(){b.go("uploadFilePage",{pageName:"bill"})},a.checkOut=function(){if(folUtil.isNull(a.query_data))return void $.messager.alert("提示","先查询一次再导出");var b=a.query_data.year+"-"+a.query_data.month;$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.getToken("services/tokens",function(a){$.messager.progress("close"),d.open("reconciliation/billFile/exportBillFile?currentDate="+b+"&token="+a.token)},function(a){$.messager.progress("close"),$.messager.alert("提示","系统错误或者超时，请刷新重试")})},a.reconciliationStatusUpdateWithPublish=function(){var b=$("#datagrid").datagrid("getSelections"),c=!1;return b.length<=0?void $.messager.alert("提示","请选择需要发布的记录，再去操作发布"):($.each(b,function(a,b){return b.status==STATE.PUBLISHED?($.messager.alert("提示","该文件已发布不能再发布"),void(c=!0)):void 0}),void(c||e.getToken("services/tokens",function(c){$.each(b,function(a,b){b.token=c.token}),e.reconciliationStatusUpdate(b,"reconciliation/billFile/publishFileStatus",function(c,d){$.messager.alert("提示","发布进行中，请稍后查看"),e.query(a.query_data,"reconciliation/billFile/queryBillFile",function(a,b){$("#datagrid").datagrid("loadData",{total:0,rows:[]}),$("#datagrid").datagrid("loadData",a)},function(a){console.log(a)}),e.reconciliationStatusUpdateWithPublish(b,"reconciliation/billFile/publishFile",function(b,c){e.query(a.query_data,"reconciliation/billFile/queryBillFile",function(a,b){$("#datagrid").datagrid("loadData",{total:0,rows:[]}),$("#datagrid").datagrid("loadData",a)},function(a){console.log(a)})},function(a,b){})},function(a,b){$.messager.alert("提示","发布失败"),console.log(a)})},function(a){console.log(a)})))},a.findReconciliationDeatil=function(){var b=$("#datagrid").datagrid("getSelections");if(b.length>0){if(b[0].status===STATE.UN_PUBLISH||b[0].status===STATE.PUBLISHING)return void $.messager.alert("提示","该文件未发布不能查看明细");c(function(){var b=$("#deatildatagrid").datagrid("getPager");b.pagination({onSelectPage:function(b,c){a.query_params.beginNo=c*(b-1)==0?0:c*(b-1)+1,a.query_params.endNo=c*b,$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.ReconciliationSignQuery(a.query_data,"reconciliation/billFile/queryBillFileDetail",function(a,b){$.messager.progress("close"),$("#deatildatagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})}})}),console.log("year1:"+a.query_data.year),$("#DeatilWindow").window("open")}else b.length>1?$.messager.alert("提示","选择多条文件，不能查看明细，请选择单条文件"):$.messager.alert("提示","请选择文件才能查看明细")}}]),FolController.controller("DealerReconciliationDeatilController",["$scope","$state","$timeout","$window","DealerReconciliationImportService",function(a,b,c,d,e){c(function(){$("#DeatilWindow").panel({onBeforeOpen:function(){$("#deatilistable").attr("class","row-fluid ng-hide"),$("#dealerCode").textbox("setValue",""),$("#dealerName").textbox("setValue",""),$("#deatilYear").textbox("setValue",a.query_data.year),$("#deatilMonth").textbox("setValue",a.query_data.month)}});var b=$("#deatildatagrid").datagrid("getPager");b.pagination({onSelectPage:function(b,c){a.query_params.beginNo=c*(b-1)==0?0:c*(b-1)+1,a.query_params.endNo=c*b,$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.ReconciliationSignQuery(a.query_data,"reconciliation/billFile/queryBillFileDetail",function(a,b){$.messager.progress("close"),$("#deatildatagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})}})}),a.ReconciliationSignQuery=function(){console.log(a.query_data);var b=$("#deatilYear").textbox("getValue")+"-"+$("#deatilMonth").textbox("getValue");a.$apply(function(){a.query_params={currentDate:b,dealerCode:folUtil.isNull(a.dealerCode)?"":a.dealerCode,dealerName:folUtil.isNull(a.dealerName)?"":a.dealerName,beginNo:0,endNo:10}}),$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.ReconciliationSignQuery(a.query_params,"reconciliation/billFile/queryBillFileDetail",function(a,b){$.messager.progress("close"),$("#deatilistable").attr("class","row-fluid ng-show"),console.log($("#deatilistable").attr("class")),$("#deatildatagrid").datagrid("loadData",{total:0,rows:[]}),$("#deatildatagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})},a.exportRecDeatil=function(){var a=$("#deatildatagrid").datagrid("getSelections");return a.length>1?void $.messager.alert("提示","不能查看多条记录的明细"):a.length<1?void $.messager.alert("提示","请选择一条记录，再点击查看明细"):($.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),void e.getToken("services/tokens",function(b){$.messager.progress("close"),d.open("reconciliation/billFile/exportBillFileDetailSingle?filedId="+a[0].filedId+"&token="+b.token)},function(a){console.log(a)}))},a.checkOutDeatil=function(){var b=a.query_data.year+"-"+a.query_data.month;$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),e.getToken("services/tokens",function(c){$.messager.progress("close"),console.log("reconciliation/billFile/exportBillFileDetail?dealerCode="+a.query_params.dealerCode+"&dealerName="+a.query_params.dealerName+"&currentDate="+b+"&token="+c.token),d.open("reconciliation/billFile/exportBillFileDetail?dealerCode="+a.query_params.dealerCode+"&dealerName="+a.query_params.dealerName+"&currentDate="+b+"&token="+c.token)},function(a){$.messager.progress("close"),$.messager.alert("提示","系统错误或者超时，请刷新重试")})}}]);