/*! web.sgm 2016-09-28 */
FolController.controller("ReturnAllowanceManagerController",["$scope","$rootScope","$timeout","$state","$stateParams","$q","$window","ReturnAllowanceManagerService","CodeService",function(a,b,c,d,e,f,g,h,i){a.istableshow=!1,a.flag=!0;var j=f.defer();j.promise;c(function(){a.setData()});var k=function(){if($("#datagrid").length>0){$("#datagrid").datagrid({onDblClickRow:function(a,b){d.go("allowanceReject",{data:b})}});var a=$("#datagrid").datagrid("getPager");a.pagination({onSelectPage:function(a,c){b.return_allowance_query_data.beginNo=c*(a-1)==0?0:c*(a-1)+1,b.return_allowance_query_data.endNo=c*a,$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT}),h.query(b.return_allowance_query_data,"returnallowance/query",function(a,b){$.messager.progress("close"),$("#datagrid").datagrid("loadData",a)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})}})}};a.query=function(){return a.istableshow=!0,b.return_allowance_query_data={sapCode:$("#sapCode").textbox("getValue"),dealerName:$("#dealerName").textbox("getValue"),allowanceNo:$("#allowanceNo").textbox("getValue"),expressNo:$("#expressNo").textbox("getValue"),status:"-1"===$("#status").combobox("getValue")?null:$("#status").combobox("getValue"),approveDateStart:$("#startTime").datebox("getValue"),approveDateEnd:$("#endTime").datebox("getValue"),companyCode:[],beginNo:0,endNo:10},!folUtil.isNull(b.return_allowance_query_data.approveDateStart)&&!folUtil.isNull(b.return_allowance_query_data.approveDateEnd)&&b.return_allowance_query_data.approveDateStart>b.return_allowance_query_data.approveDateEnd?void $.messager.alert("提示","开始日期不能大于结束日期"):(folUtil.isNull($("#shanghai").attr("checked"))||b.return_allowance_query_data.companyCode.push(COMPANY_CODE.SH),folUtil.isNull($("#tianjin").attr("checked"))||b.return_allowance_query_data.companyCode.push(COMPANY_CODE.TJ),folUtil.isNull($("#chongqin").attr("checked"))||b.return_allowance_query_data.companyCode.push(COMPANY_CODE.CQ),void h.query(b.return_allowance_query_data,"returnallowance/query",function(b,c){$.messager.progress("close"),a.flag&&k(),$("#datagrid").datagrid("loadData",{rows:[],total:0}),$("#datagrid").datagrid("loadData",b),a.flag=!1},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))}))},a.reset=function(){$("#sapCode").textbox("setValue",null),$("#dealerName").textbox("setValue",null),$("#allowanceNo").textbox("setValue",null),$("#expressNo").textbox("setValue",null),$("#status").combobox("select",-1),$("#startTime").datebox("setValue",null),$("#endTime").datebox("setValue",null),$("#shanghai").attr("checked",!1),$("#tianjin").attr("checked",!1),$("#chongqin").attr("checked",!1)},a.findDealer=function(){d.go("findDealer",{stateName:"allowanceScanManager"})},a.report=function(){var b=$("#datagrid").datagrid("getChecked");return b.length<=0?void $.messager.alert("提示","请选择一条记录"):void(confirm("确认开票？")&&h.report(b,"returnallowance/billing",function(b,c){$.messager.alert("提示","开票成功"),a.query()},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","开票失败，原因："+a.message)}))},a.reject=function(){var b=$("#datagrid").datagrid("getChecked");return b.length<=0?void $.messager.alert("提示","请选择一条记录"):void(confirm("确认拒绝？")&&h.reject(b,"returnallowance/reject",function(b,c){$.messager.alert("提示","拒绝成功"),a.query()},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","拒绝失败，原因："+a.message)}))},a.exportExcel=function(){return folUtil.isNull(b.return_allowance_query_data)?void $.messager.alert("提示","请先查询一次再导出"):void h.getToken("services/tokens",function(a,b){var c=[];folUtil.isNull($("#shanghai").attr("checked"))||c.push(COMPANY_CODE.SH),folUtil.isNull($("#tianjin").attr("checked"))||c.push(COMPANY_CODE.TJ),folUtil.isNull($("#chongqin").attr("checked"))||c.push(COMPANY_CODE.CQ);var d="";angular.forEach(c,function(a,b){d+=a+","});var e="returnallowance/exportListExcel",f="?sapCode="+$("#sapCode").textbox("getValue")+"&dealerName="+encodeURI(encodeURI($("#dealerName").textbox("getValue")))+"&allowanceNo="+$("#allowanceNo").textbox("getValue")+"&expressNo="+$("#expressNo").textbox("getValue")+"&status="+("-1"===$("#status").combobox("getValue")?null:$("#status").combobox("getValue"))+"&approveDateStart="+$("#startTime").datebox("getValue")+"&approveDateEnd="+$("#endTime").datebox("getValue")+"&companyCodeStr="+d.substr(0,d.length-1);g.open(e+f)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})},a.exportTxt=function(){var a=$("#datagrid").datagrid("getChecked");if(a.length<=0)return void $.messager.alert("提示","请选择一条记录");var b="";angular.forEach(a,function(a,c){b+=a.id+","}),h.getToken("services/tokens",function(a,c){var d="returnallowance/exportBillingFile",e="?ids="+b.substr(0,b.length-1);g.open(d+e)},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})},a.allowanceDeatil=function(){var a=$("#datagrid").datagrid("getChecked");return a.length<=0?void $.messager.alert("提示","请选择一条记录"):a.length>1?void $.messager.alert("提示","不能选择多条记录"):void d.go("allowanceReject",{data:a[0]})},a.setData=function(){if(folUtil.isNull(b.return_allowance_query_data)){folUtil.isNull(e.data)||$("#sapCode").textbox("setValue",e.data.sapCodes),$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT});var c=["折让单处理状态"];i.findCodeTypeNames(c,"code/findCodeTypeNames",function(a){$.messager.progress("close");if(!folUtil.isNull(a[0])){var b=[];angular.forEach(a[0],function(a,c){"3"!=a.code&&"1"!=a.code&&b.push(a)}),$("#status").combobox("loadData",b),$("#status").combobox("select",a[0][0].code)}},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))})}else{folUtil.isNull(b.return_allowance_query_data.sapCode)||$("#sapCode").textbox("setValue",b.return_allowance_query_data.sapCode),folUtil.isNull(b.return_allowance_query_data.dealerName)||$("#dealerName").textbox("setValue",b.return_allowance_query_data.dealerName),folUtil.isNull(b.return_allowance_query_data.allowanceNo)||$("#allowanceNo").textbox("setValue",b.return_allowance_query_data.allowanceNo),folUtil.isNull(b.return_allowance_query_data.expressNo)||$("#expressNo").textbox("setValue",b.return_allowance_query_data.expressNo),folUtil.isNull(b.return_allowance_query_data.approveDateStart)||$("#startTime").datebox("setValue",b.return_allowance_query_data.approveDateStart),folUtil.isNull(b.return_allowance_query_data.approveDateEnd)||$("#endTime").datebox("setValue",b.return_allowance_query_data.approveDateEnd),!folUtil.isNull(b.return_allowance_query_data.companyCode)&&b.return_allowance_query_data.companyCode.length>0&&angular.forEach(b.return_allowance_query_data.companyCode,function(a,b){a===COMPANY_CODE.SH?$("#shanghai").attr("checked",!0):a===COMPANY_CODE.CQ?$("#chongqin").attr("checked",!0):a===COMPANY_CODE.TJ&&$("#tianjin").attr("checked",!0)}),folUtil.isNull(e.data)||$("#sapCode").textbox("setValue",e.data.sapCodes),$.messager.progress({title:"Please waiting",msg:"Loading data...",interval:PROGRESS_ACTION_TIMEOUT});var c=["折让单处理状态"];i.findCodeTypeNames(c,"code/findCodeTypeNames",function(c){$.messager.progress("close");if(!folUtil.isNull(c[0])){var d=[];angular.forEach(c[0],function(a,b){"3"!=a.code&&"1"!=a.code&&d.push(a)}),$("#status").combobox("loadData",d),folUtil.isNull(b.return_allowance_query_data.status)||$("#status").combobox("select",b.return_allowance_query_data.status),a.query()}},function(a){$.messager.progress("close"),a.state===STATE.TIMEOUT&&(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问"))}),$("#datagrid").datagrid("loadData",{rows:[],total:0})}}}]),FolController.controller("ReturnAllowanceRejectController",["$scope","$rootScope","$timeout","$state","$stateParams","$q","ReturnAllowanceManagerService",function(a,b,c,d,e,f,g){var h=f.defer(),i=h.promise;a.isShowXmlInfo=!1,a.openDeatilButtonText="展开详细信息",a.xmlInfo,c(function(){h.resolve(),i.then(function(){g.deatilQuery({id:e.data.id},"returnallowance/queryReturnAllowanceById",function(b,c){a.allowance={allowanceNo:b.allowanceNo,expressNo:b.expressNo,expressSendTime:b.expressSendTime,companyName:b.companyName,address:b.address,phone:b.phone,bankAccount:b.bankAccount,reqBillNo:b.reqBillNo,sapCode:b.sapCode,customerRemark:b.customerRemark}},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","查询失败，原因："+a.message)})}).then(function(){g.downlandXmlInfo("returnallowance/getXmlInfo?fileId="+e.data.filedId,function(b,c){a.xmlInfo=b},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","查询失败，原因："+a.message)})}),g.deatilQuery({returnOrderId:e.data.claimReturnOrderId},"returnallowance/queryReturnOrderDetailByRoId",function(a,b){$("#returndatagrid").datagrid("loadData",a)},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","查询失败，原因："+a.message)}),g.deatilQuery({returnOrderId:e.data.claimReturnOrderId},"returnallowance/queryInvoiceDetailByRoId",function(a,b){$("#inovicedatagrid").datagrid("loadData",a)},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","查询失败，原因："+a.message)})}),a.reject=function(){if(confirm("确认拒绝？")){var b={approveMsg:a.approveMsg,id:e.data.id,returnOrderNo:e.data.returnOrderNo,sapCode:e.data.sapCode,sign:e.data.sign};g.reject([b],"returnallowance/reject",function(a,b){$.messager.alert("提示","拒绝成功"),d.go("allowanceScanManager")},function(a){a.state===STATE.TIMEOUT?(console.log("timeout"),$.messager.alert("提示","系统超时请稍后访问")):$.messager.alert("提示","拒绝失败，原因："+a.message)})}},a.back=function(){d.go("allowanceScanManager")},a.openDeatil=function(){"展开详细信息"===a.openDeatilButtonText?(a.$apply(function(){a.isShowXmlInfo=!0,a.openDeatilButtonText="关闭详细信息"}),j(a.xmlInfo)):a.$apply(function(){a.isShowXmlInfo=!1,a.openDeatilButtonText="展开详细信息"})};var j=function(a){$("#ReqBillNo").textbox("setValue",a.ReqBillNo),$("#InvKind").textbox("setValue","0"===a.InvKind||"1"===a.InvKind?InvKind.specialInvoice:a.InvKind),$("#Szlb").textbox("setValue",a.Szlb),$("#TypeCode").textbox("setValue",a.TypeCode),$("#InvNo").textbox("setValue",a.InvNo),$("#date").textbox("setValue",a.date),$("#BuyerName").textbox("setValue",a.BuyerName),$("#BuyTaxCode").textbox("setValue",a.BuyTaxCode),$("#SellerName").textbox("setValue",a.SellerName),$("#SellTaxCode").textbox("setValue",a.SellTaxCode),$("#Amount").textbox("setValue",a.Amount),$("#TaxRate").textbox("setValue",a.TaxRate),$("#Tax").textbox("setValue",a.Tax),$("#ReqMemo").textbox("setValue",a.ReqMemo),$("#Reason").textbox("setValue",a.Reason),$("#Operator").textbox("setValue",a.Operator),$("#commoditydatagrid").datagrid("loadData",{total:a.RedInvReqBillMx.length,rows:a.RedInvReqBillMx})}}]);